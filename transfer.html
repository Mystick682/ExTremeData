<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transfer Funds - ExTremeData</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
  /* --- PROFESSIONAL DESIGN SYSTEM (UNCHANGED) --- */
  :root {
    --color-primary: #2563EB; --color-primary-hover: #1D4ED8; --color-primary-light: #EFF6FF;
    --color-text-primary: #1E293B; --color-text-secondary: #64748B; --color-border: #E2E8F0;
    --color-background: #F8FAFC; --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-interactive: 0 0 0 4px rgb(59 130 246 / 0.25);
  }
  .dark {
    --color-primary: #3B82F6; --color-primary-hover: #60A5FA; --color-primary-light: #1F2937;
    --color-text-primary: #F8FAFC; --color-text-secondary: #94A3B8; --color-border: #334155;
    --color-background: #0F172A;
  }
  body { background-color: var(--color-background); color: var(--color-text-primary); font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
  .header-nav { background-color: white; border-bottom: 1px solid var(--color-border); box-shadow: var(--shadow-md); }
  .dark .header-nav { background-color: #111827; }
  .section-card { background-color: white; border: 1px solid var(--color-border); border-radius: 1.5rem; padding: 1.5rem; box-shadow: var(--shadow-md); }
  .dark .section-card { background-color: var(--color-primary-light); }
  .elegant-input, .elegant-select { background-color: var(--color-background); border: 2px solid var(--color-border); border-radius: 0.75rem; padding: 0.75rem 1rem; transition: all 0.2s ease-in-out; width: 100%; }
  .elegant-input:focus, .elegant-select:focus { border-color: var(--color-primary); box-shadow: var(--shadow-interactive); outline: none; }
  .btn-primary { background-color: var(--color-primary); color: white; border-radius: 0.75rem; padding: 0.75rem 1.5rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: var(--shadow-md); display: flex; align-items: center; justify-content: center; }
  .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-hover); transform: translateY(-1px); }
  .btn-primary:disabled { background-color: #94A3B8; cursor: not-allowed; box-shadow: none; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .loading { animation: spin 1s linear infinite; }
  #passwordModal { display: flex; opacity: 0; visibility: hidden; transition: all 0.2s ease-in-out; }
  #passwordModal.visible { opacity: 1; visibility: visible; }
  #passwordModalContent { transform: scale(0.95); transition: all 0.2s ease-in-out; }
  #passwordModal.visible #passwordModalContent { transform: scale(1); }
  </style>
</head>

<body class="min-h-screen">
  <!-- Navigation -->
  <nav class="header-nav sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <a href="data.html" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i></a>
          <h1 class="text-lg font-bold">Transfer to Bank Account</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <div class="text-xs text-slate-500 dark:text-slate-400">Balance</div>
            <div id="walletBalance" class="font-bold text-lg">Loading...</div>
          </div>
          <div id="userAvatar" class="w-10 h-10 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full flex items-center justify-center font-bold text-sm">?</div>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-md mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
    <!-- Step 1: Recipient Details -->
    <section class="section-card">
      <h2 class="text-xl font-bold mb-4 flex items-center"><div class="w-8 h-8 mr-3 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 flex items-center justify-center font-bold text-lg">1</div>Recipient Details</h2>
      <div class="space-y-4">
        <div>
          <label for="bankList" class="text-sm font-medium text-slate-600 dark:text-slate-300 block mb-1">Select Bank</label>
          <select id="bankList" class="elegant-select text-lg">
            <option value="">Loading banks...</option>
          </select>
        </div>
        <div>
          <label for="accountNumber" class="text-sm font-medium text-slate-600 dark:text-slate-300 block mb-1">Account Number</label>
          <input type="number" id="accountNumber" placeholder="Enter account number" class="elegant-input text-lg font-medium">
        </div>
        <button id="verifyBtn" class="btn-primary w-full" disabled>
          <span id="verifyBtnText">Verify Account</span>
          <i id="verifyBtnSpinner" data-lucide="loader" class="loading w-5 h-5 ml-2 hidden"></i>
        </button>
        <div id="verificationResult" class="hidden mt-4 p-3 rounded-lg bg-green-50 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-center">
          <div class="text-sm text-green-800 dark:text-green-300">Account Name</div>
          <div id="accountName" class="font-bold text-green-900 dark:text-green-200"></div>
        </div>
        <div id="verificationError" class="hidden mt-4 text-sm text-center text-red-600"></div>
      </div>
    </section>

    <!-- Step 2: Amount & Summary -->
    <div id="amountSection" class="space-y-6 hidden">
      <section class="section-card">
        <h2 class="text-xl font-bold mb-4 flex items-center"><div class="w-8 h-8 mr-3 rounded-lg bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 flex items-center justify-center font-bold text-lg">2</div>Amount</h2>
        <div class="relative">
          <span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-lg text-slate-400">₦</span>
          <input type="number" id="transferAmount" placeholder="100 - 1,000,000" class="elegant-input w-full text-lg font-medium pl-10">
        </div>
        <p class="text-xs text-slate-400 mt-2">A transfer fee may apply.</p>
      </section>
      
      <div class="text-center">
        <button id="purchaseBtn" class="btn-primary w-full text-base" disabled>
          <span>Send Money</span>
          <i data-lucide="loader" class="loading w-5 h-5 ml-2 hidden"></i>
        </button>
      </div>
    </div>
  </main>

  <!-- Password Modal -->
  <div id="passwordModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="section-card w-full max-w-sm" id="passwordModalContent">
      <h2 class="text-xl font-bold mb-1 text-center">Confirm Transfer</h2>
      <p class="text-sm text-center text-slate-500 mb-6">Enter your password to authorize this transfer.</p>
      <div class="relative">
        <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
        <input type="password" id="confirmPasswordInput" placeholder="Enter your password" class="elegant-input w-full text-lg pl-12 pr-12">
        <button type="button" id="passwordToggleBtn" class="absolute right-4 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="eye" class="w-5 h-5"></i></button>
      </div>
      <p id="passwordError" class="text-center text-sm text-red-500 h-5 my-4"></p>
      <div class="flex justify-center space-x-3">
        <button id="passwordCancelBtn" class="btn-primary bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 w-full">Cancel</button>
        <button id="passwordConfirmBtn" class="btn-primary w-full" disabled>
          <span class="flex items-center justify-center space-x-2">
            <span id="passwordConfirmBtnText">Confirm</span>
            <i data-lucide="loader" class="loading w-5 h-5 hidden" id="passwordConfirmBtnLoader"></i>
          </span>
        </button>
      </div>
    </div>
  </div>

<script>
// --- GLOBAL SETUP ---
const SUPABASE_URL = 'https://nzwrrahwgtisyxouplnu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56d3JyYWh3Z3Rpc3l4b3VwbG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MDk1NzAsImV4cCI6MjA3MTQ4NTU3MH0.kvc0VtfT_isXxP4i9XCzUiwOVLVl7Hni6rSXmIAaLHw';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- MAIN APPLICATION CLASS ---
class TransferManager {
  constructor() {
    this.localUserData = null;
    this.supabaseUser = null;
    this.userBalance = 0;
    this.selectedBankCode = null;
    this.accountNumber = '';
    this.verifiedAccountName = null;
    this.transferAmount = 0;
  }

  async initialize() {
    this.applyDarkMode();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = "signin.html"; return; }
    this.supabaseUser = user;
    this.loadLocalUserData();
    this.initializeUI();
    this.setupEventListeners();
  }

  async initializeUI() {
    const initials = (this.localUserData.firstName?.charAt(0) || '') + (this.localUserData.lastName?.charAt(0) || '');
    document.getElementById('userAvatar').textContent = initials.toUpperCase() || '?';
    await this.loadWalletBalance();
    await this.loadBankList();
    lucide.createIcons();
  }
  
  setupEventListeners() {
    window.addEventListener('storage', (e) => { if (e.key === 'xt_theme') this.applyDarkMode(); });
    document.getElementById('bankList').addEventListener('change', (e) => { this.selectedBankCode = e.target.value; this.checkCanVerify(); });
    document.getElementById('accountNumber').addEventListener('input', (e) => { this.accountNumber = e.target.value.replace(/\D/g, ''); this.checkCanVerify(); });
    document.getElementById('verifyBtn').addEventListener('click', () => this.handleVerifyAccount());
    document.getElementById('transferAmount').addEventListener('input', (e) => { this.transferAmount = parseFloat(e.target.value) || 0; this.checkCanPurchase(); });
    document.getElementById('purchaseBtn').addEventListener('click', () => this.startPurchase());
    this.setupPasswordModalListeners();
  }

  async loadBankList() {
    const select = document.getElementById('bankList');
    try {
      const response = await fetch('https://api.paystack.co/bank');
      const data = await response.json();
      if (!data.status) throw new Error('Could not fetch bank list');
      
      select.innerHTML = '<option value="">Select a bank</option>';
      data.data.forEach(bank => {
        const option = new Option(`${bank.name}`, bank.code);
        select.add(option);
      });
    } catch (error) {
      select.innerHTML = '<option value="">Error loading banks</option>';
    }
  }

  checkCanVerify() {
    document.getElementById('verifyBtn').disabled = !(this.selectedBankCode && this.accountNumber.length === 10);
    this.resetVerification();
  }
  
  checkCanPurchase() {
      document.getElementById('purchaseBtn').disabled = !(this.transferAmount >= 100);
  }

  async handleVerifyAccount() {
    const verifyBtn = document.getElementById('verifyBtn');
    const btnText = document.getElementById('verifyBtnText');
    const spinner = document.getElementById('verifyBtnSpinner');
    const resultDiv = document.getElementById('verificationResult');
    const errorDiv = document.getElementById('verificationError');
    
    verifyBtn.disabled = true;
    btnText.textContent = 'Verifying...';
    spinner.classList.remove('hidden');
    resultDiv.classList.add('hidden');
    errorDiv.classList.add('hidden');

    try {
      const { data, error } = await supabase.functions.invoke('verify-bank-account', {
        body: { bankCode: this.selectedBankCode, accountNumber: this.accountNumber }
      });
      if (error || data.error) throw error || new Error(data.error);

      this.verifiedAccountName = data.accountName;
      document.getElementById('accountName').textContent = this.verifiedAccountName;
      resultDiv.classList.remove('hidden');
      document.getElementById('amountSection').classList.remove('hidden');

    } catch(err) {
      errorDiv.textContent = err.message;
      errorDiv.classList.remove('hidden');
    } finally {
      verifyBtn.disabled = false;
      btnText.textContent = 'Verify Account';
      spinner.classList.add('hidden');
    }
  }

  resetVerification() {
    this.verifiedAccountName = null;
    this.transferAmount = 0;
    document.getElementById('verificationResult').classList.add('hidden');
    document.getElementById('verificationError').classList.add('hidden');
    document.getElementById('amountSection').classList.add('hidden');
    document.getElementById('transferAmount').value = '';
    document.getElementById('purchaseBtn').disabled = true;
  }
  
  // --- PASSWORD MODAL & PURCHASE FLOW (Reused from other pages) ---
  setupPasswordModalListeners() { /* ... same as other pages ... */ }
  togglePasswordVisibility() { /* ... same as other pages ... */ }
  showPasswordModal() { /* ... same as other pages ... */ }
  hidePasswordModal() { /* ... same as other pages ... */ }

  async startPurchase() {
    if (this.transferAmount > this.userBalance) {
      Swal.fire({ icon: 'error', title: 'Insufficient Balance', text: 'You do not have enough funds for this transfer.', confirmButtonColor: 'var(--color-primary)' });
      return;
    }
    const result = await Swal.fire({
      title: 'Confirm Transfer',
      html: `Are you sure you want to send <b>₦${this.transferAmount.toLocaleString()}</b> to <b>${this.verifiedAccountName}</b>?`,
      icon: 'question', showCancelButton: true, confirmButtonColor: 'var(--color-primary)',
      cancelButtonColor: '#64748B', confirmButtonText: 'Yes, Send Money!', cancelButtonText: 'Cancel'
    });
    if (result.isConfirmed) {
      this.showPasswordModal();
    }
  }
  
  async processPurchase(password) {
    const btn = document.getElementById('purchaseBtn');
    const spinner = btn.querySelector('i');
    const passwordConfirmBtn = document.getElementById('passwordConfirmBtn');
    const passwordConfirmBtnText = document.getElementById('passwordConfirmBtnText');
    const passwordConfirmBtnLoader = document.getElementById('passwordConfirmBtnLoader');
    
    passwordConfirmBtn.disabled = true;
    passwordConfirmBtnText.classList.add('hidden');
    passwordConfirmBtnLoader.classList.remove('hidden');

    try {
      const { error: signInError } = await supabase.auth.signInWithPassword({
        email: this.supabaseUser.email,
        password: password,
      });
      if (signInError) throw new Error("Invalid password. Please try again.");
      
      btn.disabled = true;
      spinner.classList.remove('hidden');
      
      const { data, error } = await supabase.functions.invoke('process-transfer', {
        body: {
          bankCode: this.selectedBankCode,
          accountNumber: this.accountNumber,
          accountName: this.verifiedAccountName,
          amount: this.transferAmount
        },
      });
      if (error || data.error) throw error || new Error(data.error);
      
      this.hidePasswordModal();
      Swal.fire({ icon: 'success', title: 'Transfer Successful!', text: `₦${this.transferAmount.toLocaleString()} has been sent to ${this.verifiedAccountName}.`, confirmButtonColor: 'var(--color-primary)' });
      
      this.userBalance = data.newBalance;
      this.loadWalletBalance();
      this.resetVerification();

    } catch (err) {
      if (err.message.includes('Invalid password')) {
        document.getElementById('passwordError').textContent = err.message;
        document.getElementById('confirmPasswordInput').focus();
      } else {
        this.hidePasswordModal();
        Swal.fire({ icon: 'error', title: 'Transfer Failed', text: err.message, confirmButtonColor: 'var(--color-primary)' });
      }
    } finally {
      btn.disabled = false;
      spinner.classList.add('hidden');
      passwordConfirmBtn.disabled = false;
      passwordConfirmBtnText.classList.remove('hidden');
      passwordConfirmBtnLoader.classList.add('hidden');
    }
  }
}

// Full helper function implementations for easy copy-paste
TransferManager.prototype.applyDarkMode = function() { const isDarkMode = localStorage.getItem('xt_theme') === 'dark'; document.documentElement.classList.toggle('dark', isDarkMode); };
TransferManager.prototype.loadLocalUserData = function() { try { const storedData = localStorage.getItem("userData"); if (!storedData) throw new Error("No local data"); this.localUserData = JSON.parse(storedData); } catch (error) { Swal.fire({ icon: 'error', title: 'Session Error', text: 'Please sign in again.'}).then(() => window.location.href = "signin.html"); }};
TransferManager.prototype.loadWalletBalance = async function() { try { const { data, error } = await supabase.from('user_profiles').select('balance').eq('id', this.supabaseUser.id).single(); if (error) throw error; this.userBalance = data ? parseFloat(data.balance) : 0; document.getElementById('walletBalance').textContent = `₦${this.userBalance.toLocaleString('en-US', { minimumFractionDigits: 2 })}`; } catch (error) { document.getElementById('walletBalance').textContent = 'Error'; }};
TransferManager.prototype.setupPasswordModalListeners = function() { const passwordInput = document.getElementById('confirmPasswordInput'); const passwordConfirmBtn = document.getElementById('passwordConfirmBtn'); const passwordToggleBtn = document.getElementById('passwordToggleBtn'); passwordToggleBtn.addEventListener('click', () => this.togglePasswordVisibility()); passwordInput.addEventListener('input', () => { document.getElementById('passwordError').textContent = ''; passwordConfirmBtn.disabled = passwordInput.value.length < 6; }); document.getElementById('passwordCancelBtn').addEventListener('click', () => this.hidePasswordModal()); passwordConfirmBtn.addEventListener('click', () => this.processPurchase(passwordInput.value)); };
TransferManager.prototype.togglePasswordVisibility = function() { const passwordInput = document.getElementById('confirmPasswordInput'); const toggleIcon = document.querySelector('#passwordToggleBtn i'); const isPassword = passwordInput.type === 'password'; passwordInput.type = isPassword ? 'text' : 'password'; toggleIcon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye'); lucide.createIcons(); };
TransferManager.prototype.showPasswordModal = function() { const passwordModal = document.getElementById('passwordModal'); passwordModal.classList.add('visible'); document.getElementById('confirmPasswordInput').value = ''; document.getElementById('confirmPasswordInput').type = 'password'; document.querySelector('#passwordToggleBtn i').setAttribute('data-lucide', 'eye'); document.getElementById('passwordConfirmBtn').disabled = true; document.getElementById('confirmPasswordInput').focus(); lucide.createIcons(); };
TransferManager.prototype.hidePasswordModal = function() { document.getElementById('passwordModal').classList.remove('visible'); };

document.addEventListener('DOMContentLoaded', () => {
  const app = new TransferManager();
  app.initialize();
});
</script>
</body>
</html>