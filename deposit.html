<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deposit Funds - ExTremeData</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Paystack JS -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
    <div class="mx-auto max-w-screen-sm px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <a href="data.html" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="arrow-left" class="w-5 h-5"></i>
        </a>
        <h1 class="font-semibold">Deposit Funds</h1>
      </div>
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 rounded-lg bg-indigo-600 text-white grid place-items-center text-xs font-bold">XT</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-screen-sm mx-auto p-4 space-y-4">
    <!-- User Info Card -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white grid place-items-center font-bold" id="userAvatar">?</div>
        <div>
          <div class="font-medium" id="userName">Loading...</div>
          <div class="text-sm text-gray-500 dark:text-gray-400" id="userEmail">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Current Balance -->
    <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-2xl p-4">
      <div class="text-sm opacity-90">Current Balance</div>
      <div class="text-2xl font-bold" id="currentBalance">‚Ç¶0.00</div>
      <div class="text-xs opacity-75 mt-1">Available for spending</div>
    </div>

    <!-- Deposit Form -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
      <h2 class="text-lg font-semibold mb-4">Add Money to Wallet</h2>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Amount (‚Ç¶)</label>
        <input 
          type="number" 
          id="deposit-amount" 
          class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" 
          placeholder="Enter amount (minimum ‚Ç¶100)"
          min="100"
        >
        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Minimum deposit: ‚Ç¶100</div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium mb-2">Quick amounts</label>
        <div class="grid grid-cols-4 gap-2">
          <button class="quick-amount bg-gray-100 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-indigo-900 text-sm py-2 rounded-lg font-medium" data-amount="500">‚Ç¶500</button>
          <button class="quick-amount bg-gray-100 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-indigo-900 text-sm py-2 rounded-lg font-medium" data-amount="1000">‚Ç¶1,000</button>
          <button class="quick-amount bg-gray-100 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-indigo-900 text-sm py-2 rounded-lg font-medium" data-amount="2000">‚Ç¶2,000</button>
          <button class="quick-amount bg-gray-100 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-indigo-900 text-sm py-2 rounded-lg font-medium" data-amount="5000">‚Ç¶5,000</button>
        </div>
      </div>
      <button 
        id="pay-button" 
        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <i data-lucide="credit-card" class="w-4 h-4"></i>
        <span>Pay with Paystack</span>
        <div class="loading hidden">
          <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
        </div>
      </button>
    </div>

    <!-- Recent Deposits -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-4 border border-gray-200 dark:border-gray-700">
      <h3 class="font-semibold mb-3">Recent Deposits</h3>
      <ul id="recentDeposits" class="space-y-2">
        <li class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg text-center text-gray-500 dark:text-gray-400 text-sm">
          Loading deposits...
        </li>
      </ul>
    </div>
  </main>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
    <!-- Nav links... -->
  </nav>

<script>
// --- SUPABASE & PAYSTACK SETUP ---
const SUPABASE_URL = 'https://nzwrrahwgtisyxouplnu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56d3JyYWh3Z3Rpc3l4b3VwbG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MDk1NzAsImV4cCI6MjA3MTQ4NTU3MH0.kvc0VtfT_isXxP4i9XCzUiwOVLVl7Hni6rSXmIAaLHw';
const PAYSTACK_PUBLIC_KEY = 'pk_test_5efae5ee5e1946d14c0fb9071f2c5ca2e6e8d17a';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

class DepositManager {
  constructor() {
    this.localUserData = null;
    this.supabaseUser = null; // This will hold the authenticated Supabase user
    this.initialize();
  }

  // --- MODIFIED: The new entry point for the page ---
  async initialize() {
    // 1. Authenticate with Supabase
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("Authentication session expired. Please sign in again.");
      window.location.href = "signin.html";
      return;
    }
    this.supabaseUser = user;
    console.log("‚úÖ Authenticated Supabase user:", this.supabaseUser.email);

    // 2. Load the user profile from localStorage
    this.loadLocalUserData();
    if (!this.localUserData) return; // Stop if local data is missing

    // 3. Setup the rest of the page
    this.initializeUI();
    this.setupEventListeners();
  }
  
  loadLocalUserData() {
    try {
      const storedData = localStorage.getItem("userData");
      if (storedData) {
        this.localUserData = JSON.parse(storedData);
        console.log("‚úÖ Local user data loaded:", this.localUserData);
      } else {
        alert("Could not find user data. Please sign in again.");
        window.location.href = "signin.html";
      }
    } catch (error) {
      console.error("‚ùå Error loading user data:", error);
      alert("Session is corrupted. Please sign in again.");
      window.location.href = "signin.html";
    }
  }

  async initializeUI() {
    // Update user info from localStorage
    const initials = (this.localUserData.firstName?.charAt(0) || '') + (this.localUserData.lastName?.charAt(0) || '');
    document.getElementById('userAvatar').textContent = initials.toUpperCase() || '?';
    document.getElementById('userName').textContent = `${this.localUserData.firstName || ''} ${this.localUserData.lastName || ''}`.trim() || 'User';
    document.getElementById('userEmail').textContent = this.localUserData.email || '';

    // Load financial data from Supabase
    await this.loadCurrentBalance();
    await this.loadRecentDeposits();

    lucide.createIcons();
  }

  setupEventListeners() {
    document.querySelectorAll('.quick-amount').forEach(button => {
      button.addEventListener('click', () => {
        document.getElementById('deposit-amount').value = button.dataset.amount;
      });
    });
    document.getElementById('pay-button').addEventListener('click', () => this.initiatePayment());
  }

  // --- MODIFIED: Now uses the authenticated user ID ---
  async loadCurrentBalance() {
    try {
      // Use the authenticated user's ID for the query
      const { data, error } = await supabase
        .from('user_profiles')
        .select('balance')
        .eq('id', this.supabaseUser.id) // Using the secure, authenticated ID
        .single();

      if (error) throw error;
      
      console.log("‚úÖ Balance loaded from database:", data.balance);
      this.updateBalanceDisplay(data.balance || 0);

    } catch (error) {
      console.error("‚ùå Balance loading error:", error);
      this.updateBalanceDisplay(0); // Show 0 on error
    }
  }

  updateBalanceDisplay(balance) {
    const balanceElement = document.getElementById('currentBalance');
    balanceElement.textContent = `‚Ç¶${parseFloat(balance || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  }

  // --- MODIFIED: Now uses the authenticated user email ---
  async loadRecentDeposits() {
    const depositsContainer = document.getElementById('recentDeposits');
    try {
      // Use the authenticated user's email for the query
      const { data, error } = await supabase
        .from('transactions')
        .select('*')
        .eq('user_email', this.supabaseUser.email) // Using the secure, authenticated email
        .eq('type', 'deposit')
        .order('created_at', { ascending: false })
        .limit(5);

      if (error) throw error;

      if (data && data.length > 0) {
        depositsContainer.innerHTML = data.map(tx => `...`).join(''); // Your existing template is fine
      } else {
        depositsContainer.innerHTML = `<li class="p-3 ...">No deposits yet</li>`;
      }
    } catch (error) {
      console.error("‚ùå Error loading deposits:", error);
      depositsContainer.innerHTML = `<li class="p-3 ...">Could not load deposits</li>`;
    }
  }

  initiatePayment() {
    const amount = parseFloat(document.getElementById('deposit-amount').value);
    if (!amount || amount < 100) {
      alert("Please enter a valid amount (minimum ‚Ç¶100)");
      return;
    }

    // Use the authenticated user's email from Supabase
    const userEmail = this.supabaseUser.email;

    const payButton = document.getElementById('pay-button');
    payButton.disabled = true;
    payButton.querySelector('.loading').classList.remove('hidden');
    
    const handler = PaystackPop.setup({
      key: PAYSTACK_PUBLIC_KEY,
      email: userEmail,
      amount: amount * 100,
      ref: `XT_${Date.now()}`,
      callback: (response) => {
        console.log("‚úÖ Payment successful:", response);
        this.verifyPaymentAndUpdateBalance(response.reference, amount);
      },
      onClose: () => {
        console.log("‚ùå Payment cancelled");
        this.resetPayButton();
      }
    });
    handler.openIframe();
  }

  // --- MODIFIED: Renamed and now uses authenticated user ---
  async verifyPaymentAndUpdateBalance(reference, amount) {
    console.log("üîç Verifying payment and updating balance for:", this.supabaseUser.email);

    try {
      // Step 1: Fetch current profile to get latest balance
      const { data: profileData, error: profileError } = await supabase
        .from('user_profiles')
        .select('balance')
        .eq('id', this.supabaseUser.id) // Securely fetch using ID
        .single();
      
      if (profileError) throw new Error("Could not fetch user profile before update.");

      const currentBalance = parseFloat(profileData.balance || 0);
      const newBalance = currentBalance + amount;

      // Step 2: Update user balance
      const { error: updateError } = await supabase
        .from('user_profiles')
        .update({ balance: newBalance })
        .eq('id', this.supabaseUser.id); // Securely update using ID
      
      if (updateError) throw new Error("Could not update user balance.");

      // Step 3: Record the transaction for history
      const { error: transactionError } = await supabase
        .from('transactions')
        .insert([{
          user_email: this.supabaseUser.email,
          type: 'deposit',
          amount: amount,
          status: 'completed',
          reference: reference,
          payment_method: 'paystack'
        }]);

      if (transactionError) {
        // This is not fatal, but should be logged. The user has been credited.
        console.warn("‚ö†Ô∏è Failed to record transaction:", transactionError);
      }

      // Step 4: Success!
      alert(`‚úÖ Payment successful! ‚Ç¶${amount.toLocaleString()} added.`);
      this.updateBalanceDisplay(newBalance);
      this.loadRecentDeposits();
      document.getElementById('deposit-amount').value = '';

    } catch (error) {
      console.error("‚ùå Verification/Credit failed:", error);
      alert(`Payment failed: ${error.message}. Please contact support with reference: ${reference}`);
    } finally {
      this.resetPayButton();
    }
  }

  resetPayButton() {
    const payButton = document.getElementById('pay-button');
    payButton.disabled = false;
    payButton.querySelector('.loading').classList.add('hidden');
  }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
  if (PAYSTACK_PUBLIC_KEY === 'YOUR_PAYSTACK_PUBLIC_KEY') {
    alert('CRITICAL: Paystack Public Key is not set. Payments will not work.');
  }
  new DepositManager();
});
</script>
</body>
</html>
