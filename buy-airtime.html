<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buy Airtime - ExTremeData</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- ▼▼▼ ADD SWEETALERT2 LIBRARY ▼▼▼ -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
  /* --- YOUR PROFESSIONAL DESIGN SYSTEM (UNCHANGED) --- */
  :root {
    --color-primary: #2563EB; --color-primary-hover: #1D4ED8; --color-primary-light: #EFF6FF;
    --color-text-primary: #1E293B; --color-text-secondary: #64748B; --color-border: #E2E8F0;
    --color-background: #F8FAFC; --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-interactive: 0 0 0 4px rgb(59 130 246 / 0.25);
  }
  .dark {
    --color-primary: #3B82F6; --color-primary-hover: #60A5FA; --color-primary-light: #1F2937;
    --color-text-primary: #F8FAFC; --color-text-secondary: #94A3B8; --color-border: #334155;
    --color-background: #0F172A;
  }
  body { background-color: var(--color-background); color: var(--color-text-primary); font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
  .header-nav { background-color: white; border-bottom: 1px solid var(--color-border); box-shadow: var(--shadow-md); }
  .dark .header-nav { background-color: #111827; }
  .section-card { background-color: white; border: 1px solid var(--color-border); border-radius: 1.5rem; padding: 1.5rem; box-shadow: var(--shadow-md); }
  .dark .section-card { background-color: var(--color-primary-light); }
  .horizontal-scroll-container { display: flex; overflow-x: auto; padding-bottom: 1rem; scrollbar-width: none; }
  .horizontal-scroll-container::-webkit-scrollbar { display: none; }
  .network-card { flex-shrink: 0; width: 140px; padding: 1rem; border: 2px solid var(--color-border); border-radius: 1rem; transition: all 0.2s ease-in-out; cursor:pointer; }
  .network-card.selected { border-color: var(--color-primary); background-color: var(--color-primary-light); transform: scale(1.05); }
  .network-logo { width: 36px; height: 36px; }
  .elegant-input { background-color: var(--color-background); border: 2px solid var(--color-border); border-radius: 0.75rem; padding: 0.75rem 1rem; transition: all 0.2s ease-in-out; }
  .elegant-input:focus { border-color: var(--color-primary); box-shadow: var(--shadow-interactive); outline: none; }
  .purchase-button { background-color: var(--color-primary); color: white; border-radius: 1rem; padding: 1rem 2rem; font-size: 1.125rem; font-weight: 600; transition: all 0.2s ease-in-out; box-shadow: var(--shadow-lg); display:flex; align-items:center; justify-content:center; }
  .purchase-button:hover:not(:disabled) { background-color: var(--color-primary-hover); transform: translateY(-2px); }
  .purchase-button:disabled { background-color: #94A3B8; cursor: not-allowed; box-shadow: none; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .loading { animation: spin 1s linear infinite; }
  /* --- NEW: Styles for the Password Modal --- */
  #passwordModal {
    display: flex;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease-in-out;
  }
  #passwordModal.visible {
    opacity: 1;
    visibility: visible;
  }
  #passwordModalContent {
    transform: scale(0.95);
    transition: all 0.2s ease-in-out;
  }
  #passwordModal.visible #passwordModalContent {
    transform: scale(1);
  }
  </style>
</head>

<body class="min-h-screen">
  <!-- Navigation (UNCHANGED) -->
  <nav class="header-nav sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <a href="data.html" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
          </a>
          <h1 class="text-lg font-bold">Buy Airtime</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right">
            <div class="text-xs text-slate-500 dark:text-slate-400">Balance</div>
            <div id="walletBalance" class="font-bold text-lg">Loading...</div>
          </div>
          <div id="userAvatar" class="w-10 h-10 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full flex items-center justify-center font-bold text-sm">?</div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content (UNCHANGED) -->
  <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
    <section class="section-card">
      <h2 class="text-xl font-bold mb-4 flex items-center"><div class="w-8 h-8 mr-3 rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 flex items-center justify-center"><i data-lucide="wifi" class="w-5 h-5"></i></div>Select Network</h2>
      <div class="horizontal-scroll-container space-x-4"></div>
    </section>
    
    <div id="detailsSection" class="space-y-6 hidden">
      <section class="section-card">
        <h2 class="text-xl font-bold mb-4 flex items-center"><div class="w-8 h-8 mr-3 rounded-lg bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-300 flex items-center justify-center"><i data-lucide="phone" class="w-5 h-5"></i></div>Enter Phone Number</h2>
        <div class="relative"><input type="tel" id="phoneNumber" placeholder="080 1234 5678" class="elegant-input w-full text-lg font-medium" maxlength="11"><i data-lucide="smartphone" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i></div>
      </section>
      <section class="section-card">
        <h2 class="text-xl font-bold mb-4 flex items-center"><div class="w-8 h-8 mr-3 rounded-lg bg-purple-100 dark:bg-purple-900 text-purple-600 dark:text-purple-300 flex items-center justify-center"><i data-lucide="wallet" class="w-5 h-5"></i></div>Enter Amount</h2>
        <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-lg text-slate-400">₦</span><input type="number" id="airtimeAmount" placeholder="50 - 10,000" class="elegant-input w-full text-lg font-medium pl-10"></div>
        <p class="text-xs text-slate-400 mt-2">Minimum purchase is ₦50.</p>
      </section>
    </div>

    <div id="summarySection" class="space-y-6 sticky bottom-4 z-30 hidden">
      <section class="section-card">
        <h3 class="text-lg font-bold mb-4">Summary</h3>
        <div class="space-y-3 text-sm">
          <div class="flex justify-between"><span class="text-slate-500">Network</span><span id="summaryNetwork" class="font-semibold">-</span></div>
          <div class="flex justify-between"><span class="text-slate-500">Phone Number</span><span id="summaryPhone" class="font-semibold">-</span></div>
          <hr class="border-dashed border-slate-200 dark:border-slate-700 my-2">
          <div class="flex justify-between items-center text-lg"><span class="font-bold">Total</span><span id="summaryAmount" class="font-bold text-2xl text-blue-600 dark:text-blue-400">₦0.00</span></div>
        </div>
      </section>
      <div class="text-center">
        <button id="purchaseBtn" class="purchase-button w-full max-w-sm mx-auto" disabled>
          <span id="purchaseBtnText">Enter Amount</span>
          <i data-lucide="arrow-right" class="w-5 h-5 ml-2" id="purchaseBtnIcon"></i>
          <i data-lucide="loader" class="loading w-5 h-5 ml-2 hidden" id="purchaseBtnLoader"></i>
        </button>
      </div>
    </div>
  </main>

  <!-- ======================================= -->
  <!-- ▼▼▼ NEW PASSWORD MODAL HTML ▼▼▼ -->
  <!-- ======================================= -->
  <div id="passwordModal" class="fixed inset-0 bg-slate-900 bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="section-card w-full max-w-sm" id="passwordModalContent">
      <h2 class="text-xl font-bold mb-1 text-center">Confirm Purchase</h2>
      <p class="text-sm text-center text-slate-500 mb-6">For your security, please enter your password to authorize this transaction.</p>
      <div class="relative">
  <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
  <input type="password" id="confirmPasswordInput" placeholder="Enter your password" class="elegant-input w-full text-lg pl-12 pr-12">
  
  <!-- ▼▼▼ THIS IS THE NEW TOGGLE BUTTON ▼▼▼ -->
  <button type="button" id="passwordToggleBtn" class="absolute right-4 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200" aria-label="Toggle password visibility">
    <i data-lucide="eye" class="w-5 h-5"></i>
  </button>
  <!-- ▲▲▲ END OF NEW TOGGLE BUTTON ▲▲▲ -->
</div>
      <p id="passwordError" class="text-center text-sm text-red-500 h-5 my-4"></p>
      <div class="flex justify-center space-x-3">
        <button id="passwordCancelBtn" class="purchase-button bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 w-full">Cancel</button>
        <button id="passwordConfirmBtn" class="purchase-button w-full" disabled>
          <span class="flex items-center justify-center space-x-2">
            <span id="passwordConfirmBtnText">Confirm</span>
            <i data-lucide="loader" class="loading w-5 h-5 hidden" id="passwordConfirmBtnLoader"></i>
          </span>
        </button>
      </div>
    </div>
  </div>
  <nav class="fixed bottom-0 left-0 right-0 z-40 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
     <div class="mx-auto max-w-screen-sm grid grid-cols-4 gap-2 px-6 py-2 text-xs">
      <a href="data.html" class="flex flex-col items-center text-indigo-600 font-medium py-1"><i data-lucide="home" class="w-5 h-5"></i><span>Home</span></a>
      <a href="deposit.html" class="flex flex-col items-center text-gray-500 dark:text-gray-400 py-1"><i data-lucide="wallet" class="w-5 h-5"></i><span>Wallet</span></a>
      <a href="#" class="flex flex-col items-center text-gray-500 dark:text-gray-400 py-1"><i data-lucide="receipt" class="w-5 h-5"></i><span>History</span></a>
      <a href="#" class="flex flex-col items-center text-gray-500 dark:text-gray-400 py-1"><i data-lucide="user" class="w-5 h-5"></i><span>Profile</span></a>
    </div>
  </nav>
  <!-- ======================================= -->
  <!-- ▲▲▲ END OF PASSWORD MODAL HTML ▲▲▲ -->
  <!-- ======================================= -->

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// --- SUPABASE & DARK MODE SETUP ---
const SUPABASE_URL = 'https://nzwrrahwgtisyxouplnu.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56d3JyYWh3Z3Rpc3l4b3VwbG51Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MDk1NzAsImV4cCI6MjA3MTQ4NTU3MH0.kvc0VtfT_isXxP4i9XCzUiwOVLVl7Hni6rSXmIAaLHw';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function applyDarkMode() {
  const isDarkMode = localStorage.getItem('xt_theme') === 'dark';
  document.documentElement.classList.toggle('dark', isDarkMode);
}
window.addEventListener('storage', (e) => { 
  if (e.key === 'xt_theme') applyDarkMode();
});
applyDarkMode();

// --- DATA ---
const networks = [ { id: 'mtn', name: 'MTN', logo: `<rect width="100" height="100" fill="#FFCC00"/><text x="50" y="60" text-anchor="middle" font-size="36" font-weight="bold" fill="#000">MTN</text>` }, { id: 'airtel', name: 'Airtel', logo: `<rect width="100" height="100" fill="#FF0000"/><text x="50" y="45" font-size="20" font-weight="bold" fill="#FFF" text-anchor="middle">Airtel</text><text x="50" y="70" font-size="14" fill="#FFF" text-anchor="middle">4G</text>` }, { id: 'glo', name: 'Glo', logo: `<rect width="100" height="100" fill="#00A651"/><text x="50" y="55" font-size="28" font-weight="bold" fill="#FFF" text-anchor="middle">Glo</text>` }, { id: '9mobile', name: '9mobile', logo: `<rect width="100" height="100" fill="#00A4E4"/><text x="50" y="60" font-size="32" font-weight="bold" fill="#FFF" text-anchor="middle">9</text><text x="50" y="80" font-size="12" fill="#FFF" text-anchor="middle">mobile</text>` } ];

class AirtimePurchaseManager {
  constructor() {
    this.localUserData = null;
    this.supabaseUser = null;
    this.userBalance = 0;
    this.selectedNetwork = null;
    this.phoneNumber = '';
    this.airtimeAmount = 0;
    this.initialize();
  }

  async initialize() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("Authentication session expired. Please sign in again.");
      window.location.href = "signin.html";
      return;
    }
    this.supabaseUser = user;
    this.loadLocalUserData();
    if (!this.localUserData) return;
    this.initializeUI();
    this.setupEventListeners();
  }
  
  loadLocalUserData() {
    try {
      const storedData = localStorage.getItem("userData");
      if (storedData) this.localUserData = JSON.parse(storedData);
      else throw new Error("Could not find user data.");
    } catch(e) {
      alert("Session corrupted. Please sign in again.");
      window.location.href = "signin.html";
    }
  }

  async initializeUI() {
    const initials = (this.localUserData.firstName?.charAt(0) || '') + (this.localUserData.lastName?.charAt(0) || '');
    document.getElementById('userAvatar').textContent = initials.toUpperCase() || '?';
    this.renderNetworkCards();
    await this.loadWalletBalance();
    lucide.createIcons();
  }

  async loadWalletBalance() {
    try {
      const { data, error } = await supabase.from('user_profiles').select('balance').eq('id', this.supabaseUser.id).single();
      if (error) throw error;
      this.userBalance = data ? parseFloat(data.balance) : 0;
      this.updateBalanceDisplay(this.userBalance);
    } catch (error) {
      document.getElementById('walletBalance').textContent = 'Error';
    }
  }

  renderNetworkCards() {
    const container = document.querySelector('.horizontal-scroll-container');
    container.innerHTML = networks.map(net => `<div class="network-card cursor-pointer text-center space-y-2" data-network="${net.id}"><div class="flex justify-center"><svg class="network-logo rounded-full" viewBox="0 0 100 100">${net.logo}</svg></div><div class="font-semibold text-sm">${net.name}</div></div>`).join('');
  }

  updateBalanceDisplay(balance) {
    document.getElementById('walletBalance').textContent = `₦${parseFloat(balance || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
  }

  setupEventListeners() {
    document.querySelector('.horizontal-scroll-container').addEventListener('click', (e) => {
      const card = e.target.closest('.network-card');
      if (!card) return;
      document.querySelectorAll('.network-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      card.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
      this.selectedNetwork = card.dataset.network;
      document.getElementById('detailsSection').classList.remove('hidden');
      this.updateState();
    });
    document.getElementById('phoneNumber').addEventListener('input', (e) => { this.phoneNumber = e.target.value.replace(/\D/g, ''); this.updateState(); });
    document.getElementById('airtimeAmount').addEventListener('input', (e) => { this.airtimeAmount = parseFloat(e.target.value) || 0; this.updateState(); });
    // --- CONNECT PURCHASE BUTTON TO NEW MODAL LOGIC ---
    document.getElementById('purchaseBtn').addEventListener('click', () => this.startPurchaseWithPassword());
    // --- SETUP LISTENERS FOR THE NEW MODAL ---
    this.setupPasswordModalListeners();
  }

  updateState() {
    const summarySection = document.getElementById('summarySection');
    const btn = document.getElementById('purchaseBtn');
    const btnText = document.getElementById('purchaseBtnText');
    const isReady = this.selectedNetwork && this.phoneNumber.length === 11 && this.airtimeAmount >= 50;
    summarySection.classList.toggle('hidden', !isReady);

    if (isReady) {
        document.getElementById('summaryNetwork').textContent = this.selectedNetwork.toUpperCase();
        document.getElementById('summaryPhone').textContent = this.phoneNumber;
        document.getElementById('summaryAmount').textContent = `₦${this.airtimeAmount.toLocaleString()}`;
        btnText.textContent = `Pay ₦${this.airtimeAmount.toLocaleString()}`;
        btn.disabled = false;
    } else {
        btn.disabled = true;
        if (!this.selectedNetwork) btnText.textContent = 'Select a Network';
        else if (this.phoneNumber.length !== 11) btnText.textContent = 'Enter Phone Number';
        else btnText.textContent = 'Enter Amount (min ₦50)';
    }
  }

  resetUI() {
    document.querySelectorAll('.network-card.selected').forEach(c => c.classList.remove('selected'));
    document.getElementById('detailsSection').classList.add('hidden');
    document.getElementById('summarySection').classList.add('hidden');
    document.getElementById('phoneNumber').value = '';
    document.getElementById('airtimeAmount').value = '';
    this.selectedNetwork = null; this.phoneNumber = ''; this.airtimeAmount = 0;
    this.updateState();
  }

  // --- NEW: Password Modal Logic ---
  setupPasswordModalListeners() {
  const passwordInput = document.getElementById('confirmPasswordInput');
  const passwordConfirmBtn = document.getElementById('passwordConfirmBtn');
  const passwordError = document.getElementById('passwordError');
  
  // --- ▼▼▼ NEW: LOGIC FOR THE VISIBILITY TOGGLE ▼▼▼ ---
  const toggleBtn = document.getElementById('passwordToggleBtn');
  const toggleIcon = toggleBtn.querySelector('i');

  toggleBtn.addEventListener('click', () => {
    // Check the current type of the input
    const isPassword = passwordInput.type === 'password';
    
    // Change the input type
    passwordInput.type = isPassword ? 'text' : 'password';
    
    // Change the icon name for lucide
    toggleIcon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
    
    // Re-render the icons to show the change
    lucide.createIcons();
  });
  // --- ▲▲▲ END OF NEW LOGIC ▲▲▲ ---

  passwordInput.addEventListener('input', () => {
    passwordError.textContent = '';
    passwordConfirmBtn.disabled = passwordInput.value.length < 6;
  });
  
  document.getElementById('passwordCancelBtn').addEventListener('click', () => this.hidePasswordModal());
  passwordConfirmBtn.addEventListener('click', () => this.processPurchase(passwordInput.value));
}

  showPasswordModal() {
    const passwordModal = document.getElementById('passwordModal');
    passwordModal.classList.add('visible');
    document.getElementById('confirmPasswordInput').value = '';
    document.getElementById('passwordConfirmBtn').disabled = true;
    document.getElementById('confirmPasswordInput').focus();
    lucide.createIcons();
  }

  hidePasswordModal() {
    const passwordModal = document.getElementById('passwordModal');
    passwordModal.classList.remove('visible');
  }

  // --- UPGRADED: Function with stylish SweetAlert2 pop-ups ---
  async startPurchaseWithPassword() {
    const planPrice = this.airtimeAmount;
    if (planPrice > this.userBalance) {
        Swal.fire({
            icon: 'error', title: 'Insufficient Balance',
            text: 'You do not have enough funds to complete this purchase.',
            confirmButtonColor: 'var(--color-primary)'
        });
        return;
    }
    const result = await Swal.fire({
        title: 'Confirm Purchase',
        html: `Are you sure you want to buy <b>₦${this.airtimeAmount.toLocaleString()}</b> airtime for <b>${this.phoneNumber}</b>?`,
        icon: 'question', showCancelButton: true,
        confirmButtonColor: 'var(--color-primary)', cancelButtonColor: '#64748B',
        confirmButtonText: 'Yes, proceed!', cancelButtonText: 'No, cancel'
    });
    if (result.isConfirmed) {
        this.showPasswordModal();
    }
  }
  
  // --- UPGRADED: Function to handle the actual purchase logic ---
  async processPurchase(password) {
    const passwordError = document.getElementById('passwordError');
    const btn = document.getElementById('purchaseBtn');
    const btnText = document.getElementById('purchaseBtnText');
    const btnIcon = document.getElementById('purchaseBtnIcon');
    const btnLoader = document.getElementById('purchaseBtnLoader');
    const passwordConfirmBtn = document.getElementById('passwordConfirmBtn');
    const passwordConfirmBtnText = document.getElementById('passwordConfirmBtnText');
    const passwordConfirmBtnLoader = document.getElementById('passwordConfirmBtnLoader');
    
    passwordConfirmBtn.disabled = true;
    passwordConfirmBtnText.classList.add('hidden');
    passwordConfirmBtnLoader.classList.remove('hidden');

    try {
        const { error: signInError } = await supabase.auth.signInWithPassword({
            email: this.supabaseUser.email,
            password: password,
        });
        if (signInError) throw new Error("Invalid password. Please try again.");
        
        btn.disabled = true;
        btnText.textContent = 'Processing...';
        btnIcon.classList.add('hidden');
        btnLoader.classList.remove('hidden');

        // NOTE: This assumes you have an Edge Function named 'purchase-airtime'
        const { data, error } = await supabase.functions.invoke('purchase-airtime', {
            body: {
                serviceID: `${this.selectedNetwork}-airtime`, // VT-Pass service ID for airtime
                phoneNumber: this.phoneNumber,
                amount: this.airtimeAmount
            },
        });
        if (error) throw error;
        if (data.error) throw new Error(data.error);
        
        this.hidePasswordModal();
        Swal.fire({
            icon: 'success', title: 'Purchase Successful!',
            text: `₦${this.airtimeAmount.toLocaleString()} airtime has been sent to ${this.phoneNumber}.`,
            confirmButtonColor: 'var(--color-primary)'
        });
        this.userBalance = data.newBalance;
        this.updateBalanceDisplay(this.userBalance);
        this.resetUI();
    } catch (err) {
        if (err.message.includes('Invalid password')) {
            passwordError.textContent = err.message;
            document.getElementById('confirmPasswordInput').focus();
        } else {
            this.hidePasswordModal();
            Swal.fire({
                icon: 'error', title: 'Purchase Failed',
                text: err.message,
                confirmButtonColor: 'var(--color-primary)'
            });
        }
    } finally {
        btn.disabled = false;
        btnIcon.classList.remove('hidden');
        btnLoader.classList.add('hidden');
        passwordConfirmBtnText.classList.remove('hidden');
        passwordConfirmBtnLoader.classList.add('hidden');
        this.updateState();
    }
  }
}

document.addEventListener('DOMContentLoaded', () => { new AirtimePurchaseManager(); });
</script>

</body>
</html>